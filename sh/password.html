<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Change Password</title>
  <link rel="stylesheet" href="./css/password.css">
</head>
<!-- Snackbar (Toast) -->
<div id="snackbar"></div>

<body>
  <div class="password-bg">
    <div class="password-card">
      <h2 class="form-title">Change Password</h2>

      <div class="form-group">
        <label>New Password</label>
        <input type="password" id="newPassword" class="input">
      </div>

      <div class="form-group">
        <label>Confirm Password</label>
        <input type="password" id="confirmPassword" class="input">
      </div>

      <div class="button-group">
        <button class="button" onclick="updatePassword()">Update Password</button>
      </div>
    </div>
  </div>
  <script src="./js/jquery-3.6.0.min.js"></script>
  <script src="./js/constant.js"></script>
  <script>
    $(document).ready(function () {
      const token = localStorage.getItem("aSessionId");
      if (!token) {
        showToast("Authentication token not found. Please log in again.");
        setTimeout(() => window.location.replace("login.html"), 2000);
        return;
      }
    });
    function showToast(message) {
      const snackbar = $("#snackbar");
      snackbar.text(message).addClass("show");
      setTimeout(() => snackbar.removeClass("show"), 3000);
    }

    function updatePassword() {
      if (validateUser()) {
        const newPassword = $('#newPassword').val().trim();
        const confirmPassword = $('#confirmPassword').val().trim();

        if (newPassword.length < 5) {
          showToast("New password must be at least 5 characters long.");
          return;
        }
        if (newPassword !== confirmPassword) {
          showToast("Passwords does not matching.");
          return;
        }

        const token = localStorage.getItem("aSessionId");
        const role = localStorage.getItem("role");

        $.ajax({
          url: `${PASSWORD_UPDATE_PATH}/${role}`,
          type: "PATCH",
          contentType: "application/json",
          data: JSON.stringify({ password: newPassword }),
          headers: {
            "Authorization": "Bearer " + token
          },
          success: function (response) {
            showToast("Password updated successfully!");
            setTimeout(() => {
              window.location.replace("profile.html");
            }, 2000);
          },
          error: function (xhr) {
            const message = xhr?.responseJSON?.message || "Something went wrong. Please try again.";
            showToast(message);
          }
        });
      }
    }

    function validateUser() {
      const token = localStorage.getItem("aSessionId");
      const role = localStorage.getItem("role");
      const expiry = localStorage.getItem("tokenExpiry");
      const now = new Date().getTime();

      if (!token || !role) {
        showToastAndRedirectToLogin("Unauthorized! Please login first.");
      } else if (!expiry || now > expiry) {
        localStorage.removeItem("aSessionId");
        localStorage.removeItem("role");
        localStorage.removeItem("tokenExpiry");
        showToastAndRedirectToLogin("Session expired. Please login again.");
      } else {
        return true;
      }
      return false;
    }

    function showToastAndRedirectToLogin(message, delay = 2000) {
      const snackbar = $("#snackbar");
      snackbar.text(message).addClass("show");

      // Remove the toast after 2 seconds
      setTimeout(() => {
        snackbar.removeClass("show");
        // Then redirect to login
        window.location.replace("login.html");
      }, delay);
    }
  </script>

</body>

</html>