<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Doctor Leave Management</title>
  <link rel="icon" type="image/png" href="./img/icon.png">
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="./css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f4f6f9;
    }

    .section-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: .75rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
      margin-top: 2rem;
    }

    .form-label {
      font-weight: 600;
    }

    .pagination .page-link {
      color: #4e73df;
    }

    .pagination .active .page-link {
      background-color: #4e73df;
      border-color: #4e73df;
      color: #fff;
    }

    /* Snackbar (Toast) */
    #snackbar {
      visibility: hidden;
      min-width: 250px;
      background-color: #000000;
      color: #ffffff;
      text-align: center;
      border-radius: 4px;
      padding: 16px;
      position: fixed;
      z-index: 999;
      left: 50%;
      bottom: 30px;
      font-size: 17px;
      transform: translateX(-50%);
    }

    #snackbar.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @keyframes fadein {
      from {
        bottom: 0;
        opacity: 0;
      }

      to {
        bottom: 30px;
        opacity: 1;
      }
    }

    @keyframes fadeout {
      from {
        bottom: 30px;
        opacity: 1;
      }

      to {
        bottom: 0;
        opacity: 0;
      }
    }

    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* background-color: rgba(0, 0, 0, 0.3); Semi-transparent */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<!-- Snackbar (Toast) -->
<div id="snackbar"></div>


<body>

  <div class="container my-4">

    <!-- <h4 class="text-primary mb-4 text-center">Doctor Leave Management</h4> -->

    <!-- Apply Leave Section -->
    <div class="section-card mb-5">
      <h5 class="mb-3 text-secondary">Apply for Leave</h5>
      <form id="leaveForm">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" id="startDate">
          </div>

          <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" id="endDate">
          </div>

          <div class="col-md-4">
            <label class="form-label">Reason</label>
            <input type="text" class="form-control" id="reason" placeholder="Enter reason">
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3 w-100">Apply Leave</button>
      </form>
    </div>

    <!-- Loader Overlay -->
    <div id="loaderOverlay" class="loader-overlay" style="display: none;">
      <div class="spinner"></div>
    </div>

    <!-- View Leaves Section -->
    <div class="section-card">
      <h5 class="mb-3 text-secondary">My Leaves</h5>

      <!-- Filter -->
      <div class="row g-3 mb-3">
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" id="filterStart">
        </div>

        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" id="filterEnd">
        </div>

        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" id="filterStatus">
            <option value="">All</option>
            <option value="BOOKED">Booked</option>
            <option value="APPROVED">Approved</option>
            <option value="REJECTED">Rejected</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Sort By</label>
          <select class="form-select" id="sortBy">
            <option value="from,asc">Start Date ↑</option>
            <option value="from,desc">Start Date ↓</option>
            <option value="status,asc">Status ↑</option>
            <option value="status,desc">Status ↓</option>
          </select>
        </div>
      </div>
      <div class="text-end">
        <button class="btn btn-outline-dark mb-4" id="filterBtn"><i class="la la-filter"></i>Filter</button>
      </div>


      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Start</th>
            <th>End</th>
            <th>Total Days</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Requested On</th>
          </tr>
        </thead>
        <tbody id="leaveTableBody"></tbody>
      </table>

      <!-- Pagination -->
      <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>

      <!-- Goto Page -->
      <div class="d-flex justify-content-center align-items-center mt-2">
        <input type="number" min="1" class="form-control w-auto me-2" id="gotoPageInput" placeholder="Page #">
        <button class="btn btn-outline-primary" id="gotoPageBtn">Go</button>
      </div>

    </div>

  </div>

  <script src="./js/jquery-3.6.0.min.js"></script>
  <script src="./js/constant.js"></script>
  <script>
    let currentPage = 0;
    const pageSize = 5;

    $('#leaveForm').submit(function (e) {
      e.preventDefault();

      if (validateUser('doctor')) {

        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        const reason = $('#reason').val().trim();

        if (!startDate || !reason) return alert('All fields are required.');
        if (endDate && endDate < startDate) return alert('End date cannot be before start date.');

        const token = localStorage.getItem('aSessionId');
        const role = localStorage.getItem("role");

        $('#loaderOverlay').show();
        $.ajax({
          url: APPLY_LEAVE + "/" + role,
          method: 'POST',
          headers: { 'Authorization': "Bearer " + token, 'Content-Type': 'application/json' },
          data: JSON.stringify({ from: startDate, to: endDate, reason }),
          success: function (response) {
            showToast(response.message);
            $('#leaveForm')[0].reset();
            loadLeaves(0);
            $('#loaderOverlay').hide();
          },
          error: function (xhr) {
            let msg = "Error applying leave";
            if (xhr && xhr.responseJSON && xhr.responseText) {
              if (xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
              } else if (xhr.responseText) {
                msg = xhr.responseText;
              }
            }
            showToast(msg);
            $('#loaderOverlay').hide();
          }
        });
      }
    });

    function loadLeaves(page) {

      if (validateUser('doctor')) {
        currentPage = page;

        const token = localStorage.getItem('aSessionId');
        const role = localStorage.getItem('role');

        const params = {
          page: currentPage,
          size: pageSize,
          sort: $('#sortBy').val(),
          from: $('#filterStart').val(),
          to: $('#filterEnd').val(),
          status: $('#filterStatus').val()
        };

        $('#loaderOverlay').show();
        $.ajax({
          url: VIEW_LEAVE + "/" + role,
          method: 'GET',
          headers: { 'Authorization': "Bearer " + token },
          data: params,
          success: function (data) {
            renderLeaves(data.content.data);
            renderPagination(data.content);
            $('#loaderOverlay').hide();
          }, error: function (xhr) {
            let msg = "Failed to load Leaves";
            if (xhr && xhr.responseJSON && xhr.responseText) {
              if (xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
              } else if (xhr.responseText) {
                msg = xhr.responseText;
              }
            }
            showToast(msg);
            $('#loaderOverlay').hide();
          }
        });
      }
    }

    function renderLeaves(leaves) {
      $('#leaveTableBody').empty();

      if (leaves.length === 0) {
        $('#leaveTableBody').append('<tr><td colspan="6" class="text-center text-muted">No leave records found</td></tr>');
        return;
      }

      leaves.forEach(leave => {
        $('#leaveTableBody').append(`
      <tr>
        <td>${leave.id}</td>
        <td>${leave.from}</td>
        <td>${leave.to}</td>
        <td>${leave.days}</td>
        <td>${leave.reason}</td>
        <td><span class="badge bg-${getStatusColor(leave.status)}">${leave.status}</span></td>
        <td>${leave.creationTime}</td>
      </tr>
    `);
      });
    }

    function getStatusColor(status) {
      switch (status) {
        case 'BOOKED': return 'warning';
        case 'APPROVED': return 'success';
        case 'REJECTED': return 'danger';
        default: return 'secondary';
      }
    }

    function renderPagination(data) {
      $('#pagination').empty();

      const disablePrev = data.first ? 'disabled' : '';
      const disableNext = data.last ? 'disabled' : '';

      $('#pagination').append(`
    <li class="page-item ${disablePrev}"><button class="page-link" onclick="loadLeaves(0)"><<</button></li>
    <li class="page-item ${disablePrev}"><button class="page-link" onclick="loadLeaves(${currentPage - 1})"><</button></li>
  `);

      let start = Math.max(0, currentPage - 4);
      let end = Math.min(data.totalPages, start + 10);
      if (end - start < 10 && start > 0) start = Math.max(0, end - 10);

      for (let i = start; i < end; i++) {
        const active = i === currentPage ? 'active' : '';
        $('#pagination').append(`<li class="page-item ${active}"><button class="page-link" onclick="loadLeaves(${i})">${i + 1}</button></li>`);
      }

      $('#pagination').append(`
    <li class="page-item ${disableNext}"><button class="page-link" onclick="loadLeaves(${currentPage + 1})">></button></li>
    <li class="page-item ${disableNext}"><button class="page-link" onclick="loadLeaves(${data.totalPages - 1})">>></button></li>
  `);
    }

    $('#filterBtn').click(() => loadLeaves(0));
    $('#gotoPageBtn').click(() => {
      const p = parseInt($('#gotoPageInput').val()) - 1;
      if (!isNaN(p)) loadLeaves(p);
    });

    $(function () {
      loadLeaves(0);
    });

    function validateUser(requiredRole) {
      const token = localStorage.getItem("aSessionId");
      const role = localStorage.getItem("role");
      const expiry = localStorage.getItem("tokenExpiry");
      const now = new Date().getTime();

      if (!token || !role) {
        showToastAndRedirectTo("Unauthorized! Please login first.", 2000, "login.html");
      } else if (!expiry || now > expiry) {
        localStorage.removeItem("aSessionId");
        localStorage.removeItem("role");
        localStorage.removeItem("tokenExpiry");
        showToastAndRedirectTo("Session expired. Please login again.", 2000, "login.html");
      } else if (requiredRole !== role) {
        showToastAndRedirectTo("You don't have access to this page.", 2000, "index.html");
      } else {
        return true;
      }
      return false;
    }

    function showToast(message) {
      const snackbar = $("#snackbar");
      snackbar.text(message).addClass("show");
      setTimeout(() => {
        snackbar.removeClass("show");
      }, 3000);
    }

    function showToastAndRedirectTo(message, delay = 2000, redirect) {
      const snackbar = $("#snackbar");
      snackbar.text(message).addClass("show");

      setTimeout(() => {
        snackbar.removeClass("show");
        window.location.replace(redirect);
      }, delay);
    }
  </script>

</body>

</html>